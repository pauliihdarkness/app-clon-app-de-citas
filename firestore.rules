rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función auxiliar para verificar autenticación
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función auxiliar para verificar si es el dueño
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Colección de usuarios (pública)
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer perfiles públicos
      allow read: if isAuthenticated();
      
      // Solo el dueño puede crear/actualizar su perfil
      allow create, update: if isOwner(userId);
      
      // Solo el dueño puede eliminar su perfil
      allow delete: if isOwner(userId);
      
      // Subcolección privada
      match /private/data {
        // Solo el dueño puede leer/escribir sus datos privados
        allow read, write: if isOwner(userId);
        
        // Prevenir edición de birthDate después de la creación
        allow update: if isOwner(userId) 
                      && (!request.resource.data.keys().hasAny(['birthDate']) 
                          || request.resource.data.birthDate == resource.data.birthDate);
      }
    }
    
    // Colección de likes
    match /likes/{likeId} {
      // Cualquier usuario autenticado puede leer likes
      allow read: if isAuthenticated();
      
      // Solo se puede crear un like si el usuario autenticado es quien lo da
      allow create: if isAuthenticated() 
                    && request.auth.uid == request.resource.data.fromUserId;
      
      // Solo el creador puede eliminar su like
      allow delete: if isAuthenticated() 
                    && request.auth.uid == resource.data.fromUserId;
      
      // No se permite actualizar likes
      allow update: if false;
    }
    
    // Colección de matches
    match /matches/{matchId} {
      // Solo los usuarios involucrados pueden leer el match
      allow read: if isAuthenticated() 
                  && request.auth.uid in resource.data.users;
      
      // Los matches pueden ser creados por el backend o por los usuarios involucrados
      allow create: if isAuthenticated()
                    && request.auth.uid in request.resource.data.users;
      
      // Permitir actualizar lastMessage y lastMessageTime (para el backend)
      allow update: if isAuthenticated()
                    && request.auth.uid in resource.data.users;
      
      // Los matches no se pueden eliminar manualmente
      allow delete: if false;
      
      // Subcolección de mensajes
      match /messages/{messageId} {
        // Solo los usuarios del match pueden leer los mensajes
        allow read: if isAuthenticated()
                    && request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users;
        
        // Solo los usuarios del match pueden crear mensajes
        allow create: if isAuthenticated()
                      && request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users
                      && request.auth.uid == request.resource.data.senderId;
        
        // No se pueden actualizar ni eliminar mensajes
        allow update, delete: if false;
      }
    }
  }
}
